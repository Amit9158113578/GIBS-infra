- name: Logstash Installation
  hosts: node3
  tasks:
    - name: Ensure logstash is at "{{ lookup('ENV','logstash_version') }}" version
      #apt: name=logstash=1:7.11.1-1 state=present
      apt: name=logstash={{ lookup('ENV','logstash_version') }} state=present
      become: yes
    
    - name: Ensures /etc/logstash/certs dir exists
      file: path=/etc/logstash/certs state=directory
      become: yes
    
    - name: Copy ca file
      copy:
        src: security/ca/ca.crt
        dest: /etc/logstash/certs/ca.crt
      become: yes

    - name: Copy config file
      copy:
        src: logstash.yml
        dest: /etc/logstash/logstash.yml
        force: yes
      become: yes    

    - name: Copy pipeline file
      copy:
        src: pipelines.yml
        dest: /etc/logstash/pipelines.yml
        force: yes
      become: yes

    - name: Copy pipeline file
      copy:
        src: pipelines/kpi_data.conf
        dest: /etc/logstash/conf.d/kpi_data.conf
        force: yes
      become: yes

    - name: Copy pipeline file
      copy:
        src: pipelines/target.conf
        dest: /etc/logstash/conf.d/target.conf
        force: yes
      become: yes

    - name: Copy pipeline file
      copy:
        src: pipelines/target.conf
        dest: /etc/logstash/conf.d/master-data.conf
        force: yes
      become: yes

    
    - name: start logstash
      service:
          name: logstash
          state: restarted
      become: yes

